# Azure App Service Deployment Template
# Generated by DevOpsAgent
# Deploy with: az deployment group create --resource-group <rg> --template-file azure_deploy.yaml

$schema: https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#
contentVersion: 1.0.0.0
parameters:
  projectName:
    type: string
    defaultValue: '{{project_name}}'
    metadata:
      description: Name of the application

  environment:
    type: string
    defaultValue: '{{environment}}'
    allowedValues:
      - dev
      - staging
      - production
    metadata:
      description: Deployment environment

  location:
    type: string
    defaultValue: '[resourceGroup().location]'
    metadata:
      description: Azure region for resources

  sku:
    type: string
    defaultValue: 'B1'
    allowedValues:
      - F1  # Free
      - B1  # Basic
      - S1  # Standard
      - P1V2  # Premium V2
    metadata:
      description: App Service Plan pricing tier

  dockerImage:
    type: string
    defaultValue: '{{docker_image}}'
    metadata:
      description: Docker image for container deployment

  containerPort:
    type: int
    defaultValue: {{port}}
    metadata:
      description: Container port

variables:
  appServicePlanName: '[concat(parameters(\'projectName\'), \'-plan\')]'
  appServiceName: '[concat(parameters(\'projectName\'), \'-\', parameters(\'environment\'))]'
  containerRegistryName: '[concat(replace(parameters(\'projectName\'), \'-\', \'\'), \'registry\')]'
  applicationInsightsName: '[concat(parameters(\'projectName\'), \'-insights\')]'

resources:
  # Container Registry
  - type: Microsoft.ContainerRegistry/registries
    apiVersion: 2021-09-01
    name: '[variables(\'containerRegistryName\')]'
    location: '[parameters(\'location\')]'
    sku:
      name: Basic
    properties:
      adminUserEnabled: true

  # App Service Plan
  - type: Microsoft.Web/serverfarms
    apiVersion: 2021-02-01
    name: '[variables(\'appServicePlanName\')]'
    location: '[parameters(\'location\')]'
    sku:
      name: '[parameters(\'sku\')]'
    kind: linux
    properties:
      reserved: true  # Required for Linux

  # Application Insights
  - type: Microsoft.Insights/components
    apiVersion: 2020-02-02
    name: '[variables(\'applicationInsightsName\')]'
    location: '[parameters(\'location\')]'
    kind: web
    properties:
      Application_Type: web
      Request_Source: rest

  # App Service (Web App)
  - type: Microsoft.Web/sites
    apiVersion: 2021-02-01
    name: '[variables(\'appServiceName\')]'
    location: '[parameters(\'location\')]'
    dependsOn:
      - '[resourceId(\'Microsoft.Web/serverfarms\', variables(\'appServicePlanName\'))]'
      - '[resourceId(\'Microsoft.Insights/components\', variables(\'applicationInsightsName\'))]'
      - '[resourceId(\'Microsoft.ContainerRegistry/registries\', variables(\'containerRegistryName\'))]'
    kind: app,linux,container
    properties:
      serverFarmId: '[resourceId(\'Microsoft.Web/serverfarms\', variables(\'appServicePlanName\'))]'
      siteConfig:
        linuxFxVersion: '[concat(\'DOCKER|\', parameters(\'dockerImage\'))]'
        appSettings:
          - name: WEBSITES_ENABLE_APP_SERVICE_STORAGE
            value: 'false'
          - name: DOCKER_REGISTRY_SERVER_URL
            value: '[concat(\'https://\', variables(\'containerRegistryName\'), \'.azurecr.io\')]'
          - name: DOCKER_REGISTRY_SERVER_USERNAME
            value: '[listCredentials(resourceId(\'Microsoft.ContainerRegistry/registries\', variables(\'containerRegistryName\')), \'2021-09-01\').username]'
          - name: DOCKER_REGISTRY_SERVER_PASSWORD
            value: '[listCredentials(resourceId(\'Microsoft.ContainerRegistry/registries\', variables(\'containerRegistryName\')), \'2021-09-01\').passwords[0].value]'
          - name: WEBSITES_PORT
            value: '[parameters(\'containerPort\')]'
          - name: ENVIRONMENT
            value: '[parameters(\'environment\')]'
          - name: APPINSIGHTS_INSTRUMENTATIONKEY
            value: '[reference(resourceId(\'Microsoft.Insights/components\', variables(\'applicationInsightsName\')), \'2020-02-02\').InstrumentationKey]'
          - name: APPLICATIONINSIGHTS_CONNECTION_STRING
            value: '[reference(resourceId(\'Microsoft.Insights/components\', variables(\'applicationInsightsName\')), \'2020-02-02\').ConnectionString]'

        alwaysOn: true
        http20Enabled: true
        minTlsVersion: '1.2'
        ftpsState: Disabled

        # Health check
        healthCheckPath: '/health'

      httpsOnly: true

      identity:
        type: SystemAssigned

outputs:
  appServiceUrl:
    type: string
    value: '[concat(\'https://\', reference(resourceId(\'Microsoft.Web/sites\', variables(\'appServiceName\'))).defaultHostName)]'

  appServiceName:
    type: string
    value: '[variables(\'appServiceName\')]'

  containerRegistryLoginServer:
    type: string
    value: '[reference(resourceId(\'Microsoft.ContainerRegistry/registries\', variables(\'containerRegistryName\'))).loginServer]'

  applicationInsightsKey:
    type: string
    value: '[reference(resourceId(\'Microsoft.Insights/components\', variables(\'applicationInsightsName\'))).InstrumentationKey]'

# Deployment Instructions:
#
# 1. Create resource group:
#    az group create --name {{project_name}}-rg --location eastus
#
# 2. Deploy template:
#    az deployment group create \
#      --resource-group {{project_name}}-rg \
#      --template-file azure_deploy.yaml
#
# 3. Build and push container:
#    az acr build --registry <registry-name> --image {{project_name}}:latest .
#
# 4. Restart app service:
#    az webapp restart --name {{project_name}}-{{environment}} --resource-group {{project_name}}-rg
#
# 5. View logs:
#    az webapp log tail --name {{project_name}}-{{environment}} --resource-group {{project_name}}-rg
#
# 6. Configure custom domain:
#    az webapp config hostname add --webapp-name {{project_name}}-{{environment}} \
#      --resource-group {{project_name}}-rg --hostname example.com
