# Google Cloud Run Deployment Template
# Generated by DevOpsAgent
# Deploy with: gcloud run services replace gcp_deploy.yaml

apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: {{project_name}}
  labels:
    environment: {{environment}}
    cloud.googleapis.com/location: {{region}}
  annotations:
    run.googleapis.com/ingress: all
    run.googleapis.com/launch-stage: BETA
spec:
  template:
    metadata:
      annotations:
        # Auto-scaling configuration
        autoscaling.knative.dev/minScale: '1'
        autoscaling.knative.dev/maxScale: '10'
        # CPU allocation
        run.googleapis.com/cpu-throttling: 'false'
        # Execution environment
        run.googleapis.com/execution-environment: gen2
    spec:
      # Container configuration
      containerConcurrency: 80
      timeoutSeconds: 300
      serviceAccountName: {{service_account}}
      containers:
      - name: {{project_name}}
        image: {{container_image}}
        ports:
        - name: http1
          containerPort: {{port}}
        env:
        - name: ENVIRONMENT
          value: {{environment}}
        - name: PORT
          value: '{{port}}'
        - name: PROJECT_ID
          value: {{project_id}}
        # Add your environment variables here
        # - name: DATABASE_URL
        #   valueFrom:
        #     secretKeyRef:
        #       name: database-url
        #       key: latest

        resources:
          limits:
            # CPU: 1 = 1 vCPU
            cpu: '1'
            # Memory in Mi or Gi
            memory: 512Mi

        # Health check
        livenessProbe:
          httpGet:
            path: /health
            port: {{port}}
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        startupProbe:
          httpGet:
            path: /health
            port: {{port}}
          initialDelaySeconds: 0
          periodSeconds: 5
          timeoutSeconds: 5
          failureThreshold: 10

  traffic:
  - percent: 100
    latestRevision: true

---
# Cloud Run Service IAM Policy (Optional)
# Allows unauthenticated access - remove for private services
apiVersion: v1
kind: Policy
metadata:
  name: {{project_name}}-policy
policy:
  bindings:
  - role: roles/run.invoker
    members:
    - allUsers

---
# Deployment Instructions:
#
# 1. Build and push container:
#    docker build -t gcr.io/{{project_id}}/{{project_name}}:latest .
#    docker push gcr.io/{{project_id}}/{{project_name}}:latest
#
# 2. Deploy to Cloud Run:
#    gcloud run services replace gcp_deploy.yaml --region={{region}}
#
# 3. Get service URL:
#    gcloud run services describe {{project_name}} --region={{region}} --format='value(status.url)'
#
# 4. View logs:
#    gcloud run services logs read {{project_name}} --region={{region}}
#
# Environment Variables from Secrets:
#    gcloud run services update {{project_name}} \
#      --update-secrets DATABASE_URL=database-url:latest \
#      --region={{region}}
#
# Custom Domain:
#    gcloud run domain-mappings create --service={{project_name}} \
#      --domain=example.com --region={{region}}
